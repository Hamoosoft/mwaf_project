databaseChangeLog:
  - changeSet:
      id: 001-create-core-tables
      author: campusshop
      changes:

        # -------------------------
        # USERS
        # -------------------------
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_users
              - column:
                  name: username
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: password_hash
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(30)
                  constraints:
                    nullable: false
              - column:
                  name: enabled
                  type: BOOLEAN
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: true

        - addUniqueConstraint:
            tableName: users
            columnNames: username
            constraintName: uk_users_username

        # -------------------------
        # CATEGORIES
        # -------------------------
        - createTable:
            tableName: categories
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_categories
              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: slug
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: true

        - addUniqueConstraint:
            tableName: categories
            columnNames: slug
            constraintName: uk_categories_slug

        # -------------------------
        # PRODUCTS
        # -------------------------
        - createTable:
            tableName: products
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_products
              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: price
                  type: NUMERIC(12,2)
                  constraints:
                    nullable: false
              - column:
                  name: stock
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: active
                  type: BOOLEAN
                  constraints:
                    nullable: false
              - column:
                  name: image_url
                  type: VARCHAR(255)
                  constraints:
                    nullable: true
              - column:
                  name: category_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: true

        - addForeignKeyConstraint:
            baseTableName: products
            baseColumnNames: category_id
            referencedTableName: categories
            referencedColumnNames: id
            constraintName: fk_products_category

        - createIndex:
            tableName: products
            indexName: idx_products_category_id
            columns:
              - column:
                  name: category_id

        # -------------------------
        # CARTS
        # -------------------------
        - createTable:
            tableName: carts
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_carts
              - column:
                  name: cart_key
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: true

        - addUniqueConstraint:
            tableName: carts
            columnNames: cart_key
            constraintName: uk_carts_cart_key

        # -------------------------
        # CART ITEMS
        # -------------------------
        - createTable:
            tableName: cart_items
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_cart_items
              - column:
                  name: cart_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: product_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: quantity
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: unit_price
                  type: NUMERIC(12,2)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: true

        - addForeignKeyConstraint:
            baseTableName: cart_items
            baseColumnNames: cart_id
            referencedTableName: carts
            referencedColumnNames: id
            constraintName: fk_cart_items_cart

        - addForeignKeyConstraint:
            baseTableName: cart_items
            baseColumnNames: product_id
            referencedTableName: products
            referencedColumnNames: id
            constraintName: fk_cart_items_product

        - createIndex:
            tableName: cart_items
            indexName: idx_cart_items_cart_id
            columns:
              - column:
                  name: cart_id

        - createIndex:
            tableName: cart_items
            indexName: idx_cart_items_product_id
            columns:
              - column:
                  name: product_id

        # -------------------------
        # ORDERS
        # -------------------------
        - createTable:
            tableName: orders
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_orders
              - column:
                  name: status
                  type: VARCHAR(30)
                  constraints:
                    nullable: false
              - column:
                  name: total
                  type: NUMERIC(12,2)
                  constraints:
                    nullable: false
              - column:
                  name: ordered_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: true

        # -------------------------
        # ORDER ITEMS
        # -------------------------
        - createTable:
            tableName: order_items
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_order_items
              - column:
                  name: order_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: product_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: product_name_snapshot
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: unit_price_snapshot
                  type: NUMERIC(12,2)
                  constraints:
                    nullable: false
              - column:
                  name: quantity
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: true

        - addForeignKeyConstraint:
            baseTableName: order_items
            baseColumnNames: order_id
            referencedTableName: orders
            referencedColumnNames: id
            constraintName: fk_order_items_order

        - addForeignKeyConstraint:
            baseTableName: order_items
            baseColumnNames: product_id
            referencedTableName: products
            referencedColumnNames: id
            constraintName: fk_order_items_product

        - createIndex:
            tableName: order_items
            indexName: idx_order_items_order_id
            columns:
              - column:
                  name: order_id

        - createIndex:
            tableName: order_items
            indexName: idx_order_items_product_id
            columns:
              - column:
                  name: product_id

        # -------------------------
        # ENVERS REVINFO (SEQUENCE-based)
        # -------------------------

        # Sequence f√ºr Revision-IDs
        - createSequence:
            sequenceName: revinfo_seq
            startValue: 1
            incrementBy: 1

        # Revision-Tabelle
        - createTable:
            tableName: revinfo
            columns:
              - column:
                  name: rev
                  type: INT
                  defaultValueComputed: "nextval('revinfo_seq')"
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_revinfo
                    nullable: false
              - column:
                  name: revtstmp
                  type: BIGINT
                  constraints:
                    nullable: true


        # -------------------------
        # ENVERS AUDIT TABLES (lowercase!)
        # -------------------------

        # products_aud (composite PK: id + rev)
        - createTable:
            tableName: products_aud
            columns:
              - column:
                  name: id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: rev
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: revtype
                  type: SMALLINT
                  constraints:
                    nullable: true
              - column:
                  name: name
                  type: VARCHAR(255)
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: price
                  type: NUMERIC(12,2)
              - column:
                  name: stock
                  type: INT
              - column:
                  name: active
                  type: BOOLEAN
              - column:
                  name: image_url
                  type: VARCHAR(255)
              - column:
                  name: category_id
                  type: BIGINT
              - column:
                  name: created_at
                  type: TIMESTAMP
              - column:
                  name: updated_at
                  type: TIMESTAMP
              - column:
                  name: version
                  type: BIGINT

        - addPrimaryKey:
            tableName: products_aud
            columnNames: id, rev
            constraintName: pk_products_aud

        - addForeignKeyConstraint:
            baseTableName: products_aud
            baseColumnNames: rev
            referencedTableName: revinfo
            referencedColumnNames: rev
            constraintName: fk_products_aud_revinfo

        # orders_aud (composite PK: id + rev)
        - createTable:
            tableName: orders_aud
            columns:
              - column:
                  name: id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: rev
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: revtype
                  type: SMALLINT
              - column:
                  name: status
                  type: VARCHAR(30)
              - column:
                  name: total
                  type: NUMERIC(12,2)
              - column:
                  name: ordered_at
                  type: TIMESTAMP
              - column:
                  name: created_at
                  type: TIMESTAMP
              - column:
                  name: updated_at
                  type: TIMESTAMP
              - column:
                  name: version
                  type: BIGINT

        - addPrimaryKey:
            tableName: orders_aud
            columnNames: id, rev
            constraintName: pk_orders_aud

        - addForeignKeyConstraint:
            baseTableName: orders_aud
            baseColumnNames: rev
            referencedTableName: revinfo
            referencedColumnNames: rev
            constraintName: fk_orders_aud_revinfo

        # order_items_aud (composite PK: id + rev)
        - createTable:
            tableName: order_items_aud
            columns:
              - column:
                  name: id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: rev
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: revtype
                  type: SMALLINT
              - column:
                  name: order_id
                  type: BIGINT
              - column:
                  name: product_id
                  type: BIGINT
              - column:
                  name: product_name_snapshot
                  type: VARCHAR(255)
              - column:
                  name: unit_price_snapshot
                  type: NUMERIC(12,2)
              - column:
                  name: quantity
                  type: INT
              - column:
                  name: created_at
                  type: TIMESTAMP
              - column:
                  name: updated_at
                  type: TIMESTAMP
              - column:
                  name: version
                  type: BIGINT

        - addPrimaryKey:
            tableName: order_items_aud
            columnNames: id, rev
            constraintName: pk_order_items_aud

        - addForeignKeyConstraint:
            baseTableName: order_items_aud
            baseColumnNames: rev
            referencedTableName: revinfo
            referencedColumnNames: rev
            constraintName: fk_order_items_aud_revinfo
